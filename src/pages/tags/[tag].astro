---
import Layout from '../../layouts/Layout.astro'
import { getCollection } from 'astro:content'

// FUNCIÓN REQUERIDA para rutas dinámicas
export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => data.draft !== true)
  
  // Recopilar todos los tags únicos
  const allTags = new Set<string>()
  allPosts.forEach(post => {
    if (post.data.tags) {
      post.data.tags.forEach(tag => allTags.add(tag))
    }
  })
  
  // Generar una ruta por cada tag
  return Array.from(allTags).map(tag => ({
    params: { tag }
  }))
}

const { tag } = Astro.params

// Obtener posts que tengan este tag
const allPosts = await getCollection('posts', ({ data }) => data.draft !== true)
const filteredPosts = allPosts.filter(post => 
  post.data.tags && post.data.tags.includes(tag)
)

// Ordenar por fecha
const sortedPosts = filteredPosts.sort((a, b) => 
  b.data.pubDate.getTime() - a.data.pubDate.getTime()
)

function formatDate(date: Date) {
  return date.toLocaleDateString('es-MX', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  })
}
---

<Layout title={`Posts con el tag: ${tag}`}>
  <div class="min-h-screen bg-gradient-to-b from-gray-50 to-white">
    <div class="mx-auto max-w-7xl py-12 px-4 sm:px-6 lg:px-8">
      <header class="mb-16 text-center">
        <div class="mb-4">
          <a 
            href={`${import.meta.env.BASE_URL}Blog`} 
            class="text-blue-600 hover:text-blue-700 font-medium inline-flex items-center gap-2"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Volver al blog
          </a>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-900">
          Tag: <span class="text-blue-600">#{tag}</span>
        </h1>
        <p class="text-lg text-gray-600">
          {sortedPosts.length} {sortedPosts.length === 1 ? 'artículo' : 'artículos'} encontrado{sortedPosts.length === 1 ? '' : 's'}
        </p>
      </header>

      {sortedPosts.length > 0 ? (
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {sortedPosts.map(post => (
            <article class="group relative bg-white rounded-2xl overflow-hidden border border-gray-200 hover:border-blue-300 hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
              <a href={`${import.meta.env.BASE_URL}Blog/${post.slug}`} class="block">
                {post.data.image?.url && (
                  <div class="aspect-video overflow-hidden bg-gray-100">
                    <img 
                      src={post.data.image.url} 
                      alt={post.data.image.alt || post.data.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    />
                  </div>
                )}

                <div class="p-6">
                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-3">
                      {post.data.tags.slice(0, 3).map((postTag: string) => (
                        <span 
                          class={`text-xs px-2.5 py-1 rounded-full font-medium ${
                            postTag === tag 
                              ? 'bg-blue-600 text-white' 
                              : 'bg-blue-50 text-blue-700'
                          }`}
                        >
                          #{postTag}
                        </span>
                      ))}
                    </div>
                  )}

                  <h2 class="text-xl font-bold mb-2 text-gray-900 group-hover:text-blue-600 transition-colors line-clamp-2">
                    {post.data.title}
                  </h2>
                  
                  <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                    {post.data.description}
                  </p>

                  <div class="flex items-center justify-between text-xs text-gray-500 pt-4 border-t border-gray-100">
                    <time datetime={post.data.pubDate.toISOString()}>
                      {formatDate(post.data.pubDate)}
                    </time>
                    <span class="font-medium text-blue-600">Leer más</span>
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg">No se encontraron artículos con este tag.</p>
          <a 
            href={`${import.meta.env.BASE_URL}Blog`}
            class="mt-4 inline-block text-blue-600 hover:text-blue-700 font-medium underline decoration-2 underline-offset-4"
          >
            Ver todos los artículos
          </a>
        </div>
      )}

      {/* Volver al blog */}
      <div class="text-center mt-12 pt-8 border-t border-gray-200">
        <a 
          href={`${import.meta.env.BASE_URL}Blog`} 
          class="text-blue-600 hover:text-blue-700 font-medium underline decoration-2 underline-offset-4"
        >
          ← Ver todos los artículos
        </a>
      </div>
    </div>
  </div>
</Layout>

<style>
  .line-clamp-2 { 
    display: -webkit-box; 
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical; 
    overflow: hidden;
  }
  .line-clamp-3 { 
    display: -webkit-box; 
    -webkit-line-clamp: 3; 
    -webkit-box-orient: vertical; 
    overflow: hidden;
  }
</style>