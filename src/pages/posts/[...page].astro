---
import Layout from '../../layouts/Layout.astro'
import { getCollection } from 'astro:content'
import type { GetStaticPaths, Page } from 'astro'
import type { CollectionEntry } from 'astro:content'

export const getStaticPaths = (async ({ paginate }) => {
	const allPosts = await getCollection('posts', ({ data }: { data: Record<string, any> }) => {
		return data.draft !== true
	})
	
	const sortedPosts = allPosts.sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => 
		b.data.pubDate.getTime() - a.data.pubDate.getTime()
	)
	
	return paginate(sortedPosts, { pageSize: 5 })
}) satisfies GetStaticPaths

type Props = {
	page: Page<CollectionEntry<'posts'>>
}

const { page } = Astro.props

function formatDate(date: Date) {
	return date.toLocaleDateString('es-MX', { 
		year: 'numeric', 
		month: 'long', 
		day: 'numeric' 
	})
}
---

<Layout title="Blog - Todos los posts">
	<div class="mx-auto max-w-6xl py-12 px-4">
		<!-- Header -->
		<header class="mb-12 text-center">
			<h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-900">
				Blog
			</h1>
			<p class="text-lg text-gray-600">
				Página {page.currentPage} de {page.lastPage}
			</p>
		</header>

		<!-- Posts Grid -->
		<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 mb-12">
			{page.data.map((post) => (
				<article class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
					<a href={`/posts/${post.slug}`} class="block">
						{post.data.image?.url && (
							<div class="aspect-video overflow-hidden bg-gray-100">
								<img 
									src={post.data.image.url} 
									alt={post.data.image.alt || post.data.title}
									class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
								/>
							</div>
						)}
						
						<div class="p-6">
							{post.data.tags && post.data.tags.length > 0 && (
								<div class="flex flex-wrap gap-2 mb-3">
									{post.data.tags.slice(0, 3).map((tag: string) => (
										<span class="text-xs bg-blue-50 text-blue-700 px-2.5 py-1 rounded-full font-medium">
											#{tag}
										</span>
									))}
								</div>
							)}

							<h2 class="text-xl font-bold mb-2 text-gray-900 hover:text-blue-600 transition-colors line-clamp-2">
								{post.data.title}
							</h2>

							<p class="text-gray-600 text-sm mb-4 line-clamp-3">
								{post.data.description}
							</p>

							<div class="flex items-center justify-between text-xs text-gray-500 pt-4 border-t border-gray-100">
								<time datetime={post.data.pubDate.toISOString()}>
									{formatDate(post.data.pubDate)}
								</time>
								<span class="font-medium text-blue-600">
									Leer más →
								</span>
							</div>
						</div>
					</a>
				</article>
			))}
		</div>

		<!-- PAGINACIÓN -->
		{page.lastPage > 1 && (
			<nav class="flex justify-center items-center gap-2">
				{/* Botón Anterior */}
				{page.url.prev ? (
					<a 
						href={page.url.prev}
						class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
					>
						← Anterior
					</a>
				) : (
					<span class="px-4 py-2 bg-gray-200 text-gray-400 rounded-lg cursor-not-allowed">
						← Anterior
					</span>
				)}

				{/* Números de página */}
				{Array.from({ length: page.lastPage }, (_, i) => i + 1).map((num) => {
					// Construir URL correcta: primera página sin número
					const pageUrl = num === 1 ? '/posts' : `/posts/${num}`
					const isCurrentPage = page.currentPage === num
					
					return (
						<a
							href={pageUrl}
							class={`px-4 py-2 rounded-lg font-medium transition-colors ${
								isCurrentPage
									? 'bg-blue-600 text-white'
									: 'bg-gray-100 text-gray-700 hover:bg-gray-200'
							}`}
							aria-current={isCurrentPage ? 'page' : undefined}
						>
							{num}
						</a>
					)
				})}

				{/* Botón Siguiente */}
				{page.url.next ? (
					<a 
						href={page.url.next}
						class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
					>
						Siguiente →
					</a>
				) : (
					<span class="px-4 py-2 bg-gray-200 text-gray-400 rounded-lg cursor-not-allowed">
						Siguiente →
					</span>
				)}
			</nav>
		)}

		{/* Info de paginación */}
		<div class="text-center mt-6 text-sm text-gray-600">
			Mostrando posts {page.start + 1} - {page.end + 1} de {page.total}
		</div>

		<!-- Botón volver -->}
		<div class="mt-12 text-center">
			<a 
				href="/" 
				class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium"
			>
				← Volver al inicio
			</a>
		</div>
	</div>
</Layout>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>