---
import Layout from '../layouts/Layout.astro'
import { getCollection } from 'astro:content'
import type { CollectionEntry } from 'astro:content'

const allPosts = await getCollection('posts', ({ data }: { data: Record<string, any> }) => data.draft !== true)
const sortedPosts = allPosts.sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => b.data.pubDate.getTime() - a.data.pubDate.getTime())
const posts = sortedPosts.slice(0, 5)
const totalPages = Math.ceil(sortedPosts.length / 5)

function formatDate(date: Date) {
  return date.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' })
}
---

<Layout title="Blog">
  <div class="mx-auto max-w-6xl py-12 px-4">
    <header class="mb-12 text-center">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-900">Blog</h1>
      <p class="text-lg text-gray-600">Todas mis entradas de blog</p>
    </header>

    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3 mb-12">
      {posts.map(post => (
        <article class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
          <a href={import.meta.env.BASE_URL + `Blog/${post.slug}`} class="block">
            {post.data.image?.url && (
              <div class="aspect-video overflow-hidden bg-gray-100">
                <img src={post.data.image.url} alt={post.data.image.alt || post.data.title} class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
              </div>
            )}

            <div class="p-6">
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-3">
                  {post.data.tags.slice(0,3).map((tag: string) => (
                    <span class="text-xs bg-blue-50 text-blue-700 px-2.5 py-1 rounded-full font-medium">#{tag}</span>
                  ))}
                </div>
              )}

              <h2 class="text-xl font-bold mb-2 text-gray-900 hover:text-blue-600 transition-colors line-clamp-2">{post.data.title}</h2>
              <p class="text-gray-600 text-sm mb-4 line-clamp-3">{post.data.description}</p>

              <div class="flex items-center justify-between text-xs text-gray-500 pt-4 border-t border-gray-100">
                <time datetime={post.data.pubDate.toISOString()}>{formatDate(post.data.pubDate)}</time>
                <span class="font-medium text-blue-600">Leer más →</span>
              </div>
            </div>
          </a>
        </article>
      ))}
    </div>

    {totalPages > 1 && (
      <div class="text-center">
        <a href={import.meta.env.BASE_URL + 'Blog/page/2'} class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ver más entradas</a>
      </div>
    )}
  </div>
</Layout>

<style>
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
</style>
